#!/usr/bin/env bash

set -e
# shellcheck disable=SC1091
source "bin/deps"

setup::gems() {
  for gem in rubocop relaxed-rubocop rubocop-performance; do
    lib::gem::install ${gem}
  done
}

setup::git() {
  [[ -L .git/hooks/pre-commit ]] || run "ln -nfs bin/pre-commit .git/hooks/pre-commit"
}

setup::install() {
  local os=$(uname -s | tr '[:upper:]' '[:lower:]')
  local setup_script
  setup_script="./bin/setup-${os}"

  if [[ -x "${setup_script}" ]]; then
    set -e
    # shellcheck disable=SC1090
    source "${setup_script}"
    # run it's main function
    eval "setup::${os} \"$*\""
    echo
    if [[ -z ${CI} ]]; then
      h2 "Please note — to print your Bazel environment run " "${bldylw}bin/show-env"
    else
      /usr/bin/env bash bin/show-env || true
    fi
  else
    error "Operating system $(uname -s) is not currently supported." >&2
  fi
  echo
  return 0
}

setup::main() {
  local action="$1"
  local func="setup::${action}"

  if lib::util::is-a-function "${func}"; then
    h2 "Executing partial setup for action ${bldylw}${action}"
    shift
    ${func} "$@"
  else
    set +e
    h2 "Installing required development dependencies for working with rules_ruby and Bazel."
    setup::gems
    [[ -z ${CI} ]] && setup::git
    setup::install "$@"
  fi
}

setup::main "$@"
