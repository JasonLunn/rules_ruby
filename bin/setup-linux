#!/usr/bin/env bash

set -xe

function setup::linux() {
  [[ -n $(command -v rvm) ]] && {
    rvm implode --force
    [[ -d ${HOME}/.rvm ]] && rm -rf "${HOME}/.rvm"
  }

  [[ -f ${HOME}/.bazelrc ]] || cp .circleci/.bazelrc "${HOME}"

  sudo apt update -y || true
  sudo apt-get install -y libreadline-dev zlib1g-dev
  sudo curl -L -o /usr/bin/bazel https://github.com/bazelbuild/bazelisk/releases/download/v1.0/bazelisk-linux-amd64
  sudo chmod +x /usr/bin/bazel
}

setup::linux

if [[ -z ${CIRCLECI} ]]; then
  /usr/bin/env bash bin/ci
else
  exit 0
fi
